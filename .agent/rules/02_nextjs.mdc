---
description: Patrones Next.js 15 App Router
globs: ["app/**/*.tsx", "app/**/*.ts"]
---

# âš›ï¸ Reglas Next.js App Router

Aplican a todos los archivos en `app/`.

---

## ğŸ–¥ï¸ Server Components por Defecto

```typescript
// âœ… Por defecto: Server Component (sin directiva)
export default async function Page() {
  const data = await fetchData(); // Fetch directo
  return <div>{data}</div>;
}

// âŒ Solo usar 'use client' cuando sea NECESARIO
```

### CuÃ¡ndo usar `'use client'`

Solo cuando necesites:
- `useState`, `useEffect`, `useReducer`
- Event handlers (`onClick`, `onChange`)
- Browser APIs (`localStorage`, `window`)
- Hooks de terceros que requieren cliente

---

## ğŸ”„ PatrÃ³n Server Actions (OBLIGATORIO)

```typescript
"use server";

// PatrÃ³n: Auth â†’ Validate â†’ Authorize â†’ Execute â†’ Revalidate
export async function createEntity(formData: FormData) {
  // 1. Auth check
  const session = await auth();
  if (!session) return { error: "No autorizado" };

  // 2. Parse & validate con Zod
  const parsed = schema.safeParse({
    name: formData.get("name"),
  });
  if (!parsed.success) return { error: parsed.error.flatten() };

  // 3. Authorization check (RBAC)
  if (!hasPermission(session.user, "create:entity")) {
    return { error: "Sin permisos" };
  }

  // 4. Business logic
  try {
    const result = await db.insert(entities).values(parsed.data);
    // 5. Revalidate
    revalidatePath("/entities");
    return { success: true, data: result };
  } catch (e) {
    return { error: "Error al crear" };
  }
}
```

---

## ğŸ“ Metadata SEO

Toda pÃ¡gina debe exportar metadata:

```typescript
// app/dashboard/page.tsx
export const metadata: Metadata = {
  title: "Dashboard | App Name",
  description: "Panel principal de la aplicaciÃ³n",
};
```

---

## ğŸ“ Estructura de Archivos

```
app/
  â”œâ”€â”€ (auth)/          # Grupo: pÃ¡ginas pÃºblicas
  â”‚   â”œâ”€â”€ login/
  â”‚   â””â”€â”€ register/
  â”œâ”€â”€ (protected)/     # Grupo: pÃ¡ginas protegidas
  â”‚   â”œâ”€â”€ dashboard/
  â”‚   â””â”€â”€ settings/
  â”œâ”€â”€ api/             # API Routes (solo si necesario)
  â”œâ”€â”€ layout.tsx       # Layout raÃ­z
  â””â”€â”€ page.tsx         # PÃ¡gina principal
```

---

## ğŸ¨ Estados UI Obligatorios

Toda pÃ¡gina/componente que carga datos debe manejar:

| Estado | ImplementaciÃ³n |
|--------|----------------|
| Loading | `loading.tsx` o `<Suspense>` con Skeleton |
| Empty | Mensaje + CTA si aplica |
| Error | `error.tsx` + mensaje claro + retry |
| Success | Render normal de datos |

---

## ğŸ“± Responsive Obligatorio

- Mobile-first: diseÃ±ar para 375px primero
- Breakpoints: `sm:640` `md:768` `lg:1024` `xl:1280`
- **NO scroll horizontal** en ningÃºn viewport
- Touch targets: mÃ­nimo 44x44px
- Input font-size: â‰¥16px (evita zoom en iOS)

---

## âŒ Anti-patrones

| âŒ No hacer | âœ… Hacer |
|-------------|----------|
| Fetch en Client Components | Server Components + Actions |
| LÃ³gica de negocio en `page.tsx` | Extraer a actions/utils |
| `console.log` en producciÃ³n | Logger o eliminar |
| CSS inline extenso | Tailwind classes |
